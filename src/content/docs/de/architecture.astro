---
import type { Locale } from '../../../i18n/locales';
interface Props { locale: Locale; }
const { locale } = Astro.props;

const archDiagram = `Browser → http://{app}.{DOMAIN}:{PORT}
       │
       └── Caddy (reverse proxy, static IP 172.28.0.250)
             ├── auth.*      → Authentik    (OIDC/SAML provider)
             ├── docs.*      → Outline      (OIDC)
             ├── chat.*      → Mattermost   (OAuth2)
             ├── git.*       → Gitea        (OIDC)
             ├── files.*     → Seafile      (OAuth2)
             ├── time.*      → Kimai        (SAML)
             ├── tasks.*     → Vikunja      (OIDC)
             ├── vault.*     → Vaultwarden  (OIDC)
             ├── mail.*      → Stalwart     (OIDC)
             ├── office.*    → OnlyOffice   (JWT)
             └── minio.*     → MinIO        (internal)`;
---

<h1>Architektur</h1>
<p class="subtitle">Wie alle Teile zusammenspielen.</p>

<h2>Hub-and-Spoke SSO</h2>
<p>Der gesamte Datenverkehr läuft über Caddy (Reverse Proxy) auf einem einzelnen Port. Caddy routet anhand der Subdomain zum richtigen Backend. Authentifizierungsflüsse laufen über Authentik als zentralen Identitäts-Hub.</p>
<pre><code set:text={archDiagram} /></pre>

<h2>Authentifizierungsprotokolle</h2>
<table>
  <tr><th>App</th><th>Protokoll</th><th>Anmerkungen</th></tr>
  <tr><td>Outline, Gitea, Vikunja, Vaultwarden, Stalwart</td><td>OIDC</td><td>Standard OpenID Connect</td></tr>
  <tr><td>Mattermost</td><td>OAuth2</td><td>Verwendet den „GitLab"-Provider-Typ (gleiches Protokoll)</td></tr>
  <tr><td>Seafile</td><td>OAuth2</td><td>Benutzerdefiniertes OAuth über gepatchte Einstellungen</td></tr>
  <tr><td>Kimai</td><td>SAML 2.0</td><td>Einzige externe Authentifizierungsmethode, die Kimai unterstützt</td></tr>
  <tr><td>OnlyOffice</td><td>JWT</td><td>Keine Benutzerkonten — Shared Secret mit Outline</td></tr>
</table>

<h2>Blueprints (Zero-Touch-Konfiguration)</h2>
<p>Authentik blueprints sind YAML-Dateien, die deklarativ alle SSO-Provider, webhook-Transports und Scope-Mappings erstellen. Sie werden in den Authentik-Worker eingebunden und beim Start automatisch angewendet — keine UI-Klicks nötig.</p>
<p>Es gibt 15 blueprints in <code>apps/authentik/blueprints/</code>: eines pro OIDC-/SAML-Provider, eines pro webhook-Transport, plus gemeinsame Scope- und Comms-Launcher-Konfigurationen.</p>

<h2>Adapters</h2>
<p>Adapters sind leichtgewichtige FastAPI-Microservices, die Authentik-Webhooks empfangen und in app-spezifische API-Aufrufe übersetzen. Es gibt 4 adapters:</p>
<table>
  <tr><th>Adapter</th><th>Empfängt</th><th>Erstellt</th></tr>
  <tr><td>outline-adapter</td><td>Gruppen-CRUD, Benutzer-Login</td><td>Outline-Gruppen + Mitgliedschaft</td></tr>
  <tr><td>mattermost-adapter</td><td>Gruppen-CRUD, Benutzer-Login</td><td>Kanäle + Mitgliedschaft + Slash-Befehle</td></tr>
  <tr><td>gitea-adapter</td><td>Gruppen-CRUD, Benutzer-Login</td><td>Organisationen + Team-Mitgliedschaft</td></tr>
  <tr><td>stalwart-adapter</td><td>Gruppen-CRUD, Benutzer-Login</td><td>Mailinglisten + JIT-Postfach-Provisioning</td></tr>
</table>

<h2>Init Containers</h2>
<p>Init containers werden beim ersten Start einmalig ausgeführt, um Apps zu konfigurieren, die nicht vollständig über Umgebungsvariablen konfiguriert werden können. Alle sind idempotent — sicher bei wiederholter Ausführung.</p>
<table>
  <tr><th>Container</th><th>Funktion</th></tr>
  <tr><td>outline-init</td><td>Erstellt API-Schlüssel, befördert ersten Benutzer zum Admin</td></tr>
  <tr><td>mattermost-init</td><td>Erstellt Team + Bot-Token + Slash-Befehle</td></tr>
  <tr><td>gitea-init</td><td>Registriert OIDC-Auth-Quelle + Service-Konto</td></tr>
  <tr><td>kimai-init</td><td>Ruft SAML-Signaturzertifikat ab, generiert Konfiguration</td></tr>
  <tr><td>stalwart-init</td><td>Erstellt Mail-Domain via REST-API</td></tr>
  <tr><td>minio-init</td><td>Erstellt S3-Bucket für Outline</td></tr>
</table>

<h2>Das Split-URL-Muster</h2>
<p>Ein kritisches Implementierungsdetail: Browser-seitige und Server-zu-Server OIDC-URLs müssen in Docker unterschiedlich sein.</p>
<ul>
  <li>Browser: <code>http://auth.localhost</code> (extern, über Caddy)</li>
  <li>Server: <code>http://authentik-server:9000</code> (Docker-interner Hostname)</li>
</ul>
<p>Apps, die separate Browser-/Server-URLs unterstützen, verwenden dieses Split direkt. Apps mit einer einzigen Authority-URL (Gitea, Vikunja, Vaultwarden) nutzen <code>extra_hosts</code>, um die Auth-Domain auf Caddys statische IP zu verweisen.</p>
