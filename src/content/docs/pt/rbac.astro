---
import type { Locale } from '../../../i18n/locales';
interface Props { locale: Locale; }
const { locale } = Astro.props;

const roleMapExample = `# Gitea adapter example
ROLE_MAPPING='{"engineering": "owner", "management": "read", "hr": null}'`;

const roleMapExclusion = `# HR should NOT see code repositories
ROLE_MAPPING='{"hr": null}'  # on the Gitea adapter

# Engineering should NOT see HR timesheets
ROLE_MAPPING='{"engineering": null}'  # on the Kimai adapter (if applicable)`;

const helmRbac = `rbac:
  groups:
    engineering:
      displayName: "Engineering"
      roles:
        gitea: owner          # Full repo access
        outline: member        # Wiki read/write
        mattermost: member     # Channel member
        kimai: user            # Track own time
        stalwart: member       # Mailing list

    management:
      displayName: "Management"
      roles:
        gitea: read            # View-only repos
        outline: admin         # Wiki admin
        mattermost: admin      # Channel admin
        kimai: teamlead        # Approve timesheets

    hr:
      displayName: "Human Resources"
      roles:
        gitea: null            # No code access
        outline: admin         # Wiki admin
        kimai: teamlead        # Approve timesheets
        stalwart: member       # Mailing list`;
---

<h1>RBAC e Mapeamento de Grupos</h1>
<p class="subtitle">A funcionalidade central: defina os grupos uma vez no Authentik e as permissões propagam-se a todas as aplicações.</p>

<h2>Como Funciona</h2>
<p>O Klyvra utiliza um modelo hub-and-spoke para controlo de acessos:</p>
<ol>
  <li>Cria um grupo no Authentik (ex.: "engineering")</li>
  <li>O Authentik dispara um webhook para os 4 adapters</li>
  <li>Cada adapter cria o recurso correspondente na sua aplicação:
    <ul>
      <li>Gitea → cria uma organização</li>
      <li>Mattermost → cria um canal</li>
      <li>Outline → cria um grupo (para permissões de coleções)</li>
      <li>Stalwart → cria uma lista de distribuição</li>
    </ul>
  </li>
  <li>Quando adiciona um utilizador ao grupo, os adapters sincronizam a adesão</li>
  <li>O papel do utilizador em cada aplicação é determinado pela configuração de role mapping</li>
</ol>

<h2>Role Mapping</h2>
<p>Cada adapter lê uma variável de ambiente <code>ROLE_MAPPING</code> (JSON) que mapeia nomes de grupos para papéis específicos da aplicação:</p>
<pre><code set:text={roleMapExample} /></pre>

<table>
  <tr><th>Valor</th><th>Efeito</th></tr>
  <tr><td><code>"owner"</code>, <code>"admin"</code>, etc.</td><td>Nome do papel específico da aplicação — veja a tabela abaixo</td></tr>
  <tr><td><code>null</code></td><td>Excluir — este grupo NÃO é sincronizado para esta aplicação</td></tr>
  <tr><td><em>(grupo não listado)</em></td><td>Papel predefinido da aplicação (normalmente <code>member</code>)</td></tr>
</table>

<h2>Papéis Disponíveis por Aplicação</h2>
<table>
  <tr><th>Aplicação</th><th>Papéis</th><th>Predefinido</th></tr>
  <tr><td>Gitea</td><td><code>owner</code> · <code>admin</code> · <code>write</code> · <code>read</code></td><td><code>owner</code></td></tr>
  <tr><td>Mattermost</td><td><code>admin</code> · <code>member</code></td><td><code>member</code></td></tr>
  <tr><td>Outline</td><td><code>admin</code> · <code>member</code> · <code>viewer</code></td><td><code>member</code></td></tr>
  <tr><td>Kimai</td><td><code>super_admin</code> · <code>teamlead</code> · <code>user</code></td><td>Mapeado via grupos SAML</td></tr>
  <tr><td>Stalwart</td><td><code>member</code></td><td><code>member</code> (lista de distribuição)</td></tr>
</table>

<h2>O Papel null (Exclusão)</h2>
<p>Definir um papel como <code>null</code> significa que o grupo é completamente invisível para essa aplicação. O adapter não cria nada — sem organização, sem canal, sem grupo. É assim que controla as fronteiras de informação:</p>
<pre><code set:text={roleMapExclusion} /></pre>

<h2>Helm Chart: RBAC Declarativo</h2>
<p>Ao utilizar o Helm chart, os role mappings são definidos de forma declarativa no <code>values.yaml</code>:</p>
<pre><code set:text={helmRbac} /></pre>

<p>O chart converte automaticamente isto em ConfigMaps de <code>ROLE_MAPPING</code> por adapter.</p>

<h2>Fila de Adesões Pendentes</h2>
<p>Se adicionar um utilizador a um grupo antes de ele ter feito login numa aplicação, o adapter coloca a adesão em fila de espera. Na próxima vez que esse utilizador fizer login (o Authentik dispara um webhook <code>user_login</code>), todas as adesões pendentes são aplicadas automaticamente.</p>

<div class="callout callout-info">
  <strong>ℹ️ Sem remoção automática</strong>
  Remover um utilizador de um grupo do Authentik NÃO o remove da aplicação correspondente. Isto é intencional — a remoção automática é destrutiva e pode causar perda de dados. Faça remoções diretamente em cada aplicação quando necessário.
</div>
