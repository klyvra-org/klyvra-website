---
import { locales, localeLabels, localeFlags, defaultLocale, type Locale } from '../i18n/locales';

interface Props {
  locale: Locale;
  currentPath: string; // e.g. '/it/features' or '/docs/quickstart'
}

const { locale, currentPath } = Astro.props;

// Strip the locale prefix to get the "base" path
function getBasePath(path: string): string {
  const segments = path.split('/').filter(Boolean);
  if (segments.length > 0 && (locales as readonly string[]).includes(segments[0])) {
    return '/' + segments.slice(1).join('/');
  }
  return path;
}

const basePath = getBasePath(currentPath);

function buildLocalizedUrl(targetLocale: Locale): string {
  const clean = basePath === '' ? '/' : basePath.startsWith('/') ? basePath : `/${basePath}`;
  if (targetLocale === defaultLocale) return clean || '/';
  return `/${targetLocale}${clean}`;
}
---

<div class="lang-switcher">
  <button class="lang-switcher-btn">
    {localeFlags[locale]} {localeLabels[locale]}
    <span style="font-size:0.65rem;">&#9662;</span>
  </button>
  <div class="lang-switcher-dropdown">
    {locales.map((loc) => (
      <a href={buildLocalizedUrl(loc)} class={loc === locale ? 'current' : ''}>
        {localeFlags[loc]} {localeLabels[loc]}
      </a>
    ))}
  </div>
</div>
